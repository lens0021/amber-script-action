---
name: Test
on:
  - push
permissions: {}
jobs:
  test-basic:
    name: Test basic script execution
    strategy:
      fail-fast: false
      matrix:
        os:
          - ubuntu-latest
          - macos-latest
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          persist-credentials: false
      - uses: ./
        with:
          amber-version: 0.4.0-alpha
          script: |
            const msg = "Hello World!"
            echo msg
            echo "The length of the previous message is {len msg}"

  test-custom-cache-path:
    name: Test with custom cache path
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          persist-credentials: false
      - uses: ./
        with:
          amber-version: 0.5.1-alpha
          cache-path: /tmp/amber-test-cache
          script: |
            const msg = "Hello World!"
            echo msg
            echo "The length of the previous message is {len msg}"

  test-outputs-single:
    name: Test single output
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          persist-credentials: false
      - uses: ./
        id: test
        with:
          amber-version: 0.5.1-alpha
          script: trust $ echo "result=success" >> \$AMBER_SCRIPT_OUTPUT $
      - name: Verify output
        env:
          OUTPUTS: ${{ steps.test.outputs.script_outputs }}
        run: |
          echo "Outputs JSON: $OUTPUTS"
          result=$(echo "$OUTPUTS" | jq -r '.result')
          if [ "$result" != "success" ]; then
            echo "Expected 'success', got '$result'"
            exit 1
          fi
          echo "Output test passed!"

  test-outputs-multiple:
    name: Test multiple outputs
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          persist-credentials: false
      - uses: ./
        id: test
        with:
          amber-version: 0.5.1-alpha
          script: |
            trust $ echo "key1=value1" >> \$AMBER_SCRIPT_OUTPUT $
            trust $ echo "key2=value2" >> \$AMBER_SCRIPT_OUTPUT $
            trust $ echo "number=42" >> \$AMBER_SCRIPT_OUTPUT $
      - name: Verify outputs
        run: |
          key1="${{ fromJSON(steps.test.outputs.script_outputs).key1 }}"
          key2="${{ fromJSON(steps.test.outputs.script_outputs).key2 }}"
          number="${{ fromJSON(steps.test.outputs.script_outputs).number }}"
          echo "key1=$key1"
          echo "key2=$key2"
          echo "number=$number"
          [ "$key1" = "value1" ] || exit 1
          [ "$key2" = "value2" ] || exit 1
          [ "$number" = "42" ] || exit 1
          echo "All outputs verified successfully!"

  test-build-from-source:
    name: Test build from specific commit
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          persist-credentials: false
      - uses: ./
        with:
          amber-repository-ref: 75a57027775f56b4044439346f2cd33df80645f9
          script: |
            echo(trust ls("."))
