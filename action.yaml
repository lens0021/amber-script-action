name: Amber Script
description: Run arbitrary Amber scripts.
branding:
  color: orange
  icon: code
inputs:
  script:
    description: >-
      The script to run.
      Note: This action does not use 'set -e'. See README for error handling details.
    required: true
  amber-version:
    default: 0.5.1-alpha
  enable-cache:
    description: Whether to cache Amber binaries and the compiled bash scripts
    default: true
  cache-path:
    description: >-
      The path to store Amber binaries and the compiled bash scripts.
      If empty string is given, the used path depends on the runner.
    default: ""
outputs:
  script_outputs:
    description: "JSON object containing all outputs set by the script via $AMBER_SCRIPT_OUTPUT"
    value: ${{ steps.run-script.outputs.script_outputs }}
runs:
  using: composite
  steps:
    - id: script-hash
      env:
        AMBER_SCRIPT_CONTENT: ${{ inputs.script }}
      shell: bash
      run: |
        # Calculate input script hash
        hash=$(printf '%s' "$AMBER_SCRIPT_CONTENT" | openssl sha256 | cut -d' ' -f2)
        echo "hash=${hash}" >> $GITHUB_OUTPUT
        echo "cache-base=${HOME}/.cache/amber-script-action" >> $GITHUB_OUTPUT
    - name: Cache compiled script
      id: cache-compiled
      uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4.3.0
      if: inputs.enable-cache
      with:
        path: ${{ inputs.cache-path != '' && format('{0}/dist/{1}.sh', inputs.cache-path, steps.script-hash.outputs.hash) || format('{0}/dist/{1}.sh', steps.script-hash.outputs.cache-base, steps.script-hash.outputs.hash) }}
        key: amber-script-action-${{ inputs.amber-version }}-${{ steps.script-hash.outputs.hash }}
    - uses: lens0021/setup-amber@58394844f9bb51e8b559f224b03f6dcb3d79f644 # v2.2.0
      id: setup-amber
      if: ${{ !inputs.enable-cache || steps.cache-compiled.outputs.cache-hit != 'true' }}
      with:
        amber-version: ${{ inputs.amber-version }}
        enable-cache: ${{ inputs.enable-cache }}
        cache-path: ${{ inputs.cache-path != '' && format('{0}/actions/setup-amber', inputs.cache-path) || format('{0}/actions/setup-amber', steps.script-hash.outputs.cache-base) }}
        bin-path: ${{ inputs.cache-path != '' && format('{0}/bin', inputs.cache-path) || format('{0}/bin', steps.script-hash.outputs.cache-base) }}
    - id: run-script
      shell: bash
      env:
        AMBER_SCRIPT_AMBER_PATH: ${{ steps.setup-amber.outputs.amber-path }}
        AMBER_SCRIPT_CACHE_PATH_INPUT: ${{ inputs.cache-path }}
        AMBER_SCRIPT_CONTENT: ${{ inputs.script }}
        AMBER_SCRIPT_HASH: ${{ steps.script-hash.outputs.hash }}
      run: |
        # Build and run script
        bash "${{ github.action_path }}/dist/main.sh"
